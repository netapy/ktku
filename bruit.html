<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>Bruit</title>
    <meta name="description" content="Kataku">
    <meta name="author" content="LFB">

    <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">

    <!-- JS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.6.1/alasql.min.js"></script>
    <script src="js/ktk.js"></script>
    <script src="js/img.js"></script>
    <script src="js/volume-meter.js"></script>

    <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="assets/icon.png">
    <link rel="apple-touch-icon" href="assets/icon192.png">

</head>

<body scroll="no" style="overflow: hidden">

    <!-- Primary Page Layout
  ––––––––––––––––––––––––––––––––––––––––––––––––––-->
    <div class="mainContainer">
        <div class="menu">
            <h5 id='titreMenu' style="margin-top:6%; width: 100%; white-space: nowrap;">Silence!</h5>
            <div
                style="width: 100%; height: 50vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <img style="width: 90%; padding: 20px 0px; max-width: 350px;" src="assets/intensite/voisine1.png" id='CetteSouffrance'>
                <span id="decibelz" style="font-size: 40px; font-family: 'GapSansBold';"></span>
                <button id="btnDebut" onclick='terr()'>Activer le micro.</button>
                <canvas id="meter" style="width: 0px;"></canvas>
            </div>
            <div style="width: 100%; font-size:1.5rem;" id='scoreChoisi'>-</div>
            <div class="logoktk">
                <img class='logobot' src="assets/logo_kataku_transpar.png" />
            </div>
        </div>
    </div>

    <script>
        var audioContext = null;
        var meter = null;
        var canvasContext = null;
        var WIDTH = 500;
        var HEIGHT = 50;
        var rafID = null;

        function terr() {
            document.getElementById("decibelz").innerHTML = "0 db"
            document.getElementById("btnDebut").style.display = "none";
            // grab our canvas
            canvasContext = document.getElementById("meter").getContext("2d");

            // monkeypatch Web Audio
            window.AudioContext = window.AudioContext || window.webkitAudioContext;

            // grab an audio context
            audioContext = new AudioContext();

            // Attempt to get audio input
            try {
                // monkeypatch getUserMedia
                navigator.getUserMedia =
                    navigator.getUserMedia ||
                    navigator.webkitGetUserMedia ||
                    navigator.mozGetUserMedia;

                // ask for an audio input
                navigator.getUserMedia({
                    "audio": {
                        "mandatory": {
                            "googEchoCancellation": "false",
                            "googAutoGainControl": "false",
                            "googNoiseSuppression": "false",
                            "googHighpassFilter": "false"
                        },
                        "optional": []
                    },
                }, onMicrophoneGranted, onMicrophoneDenied);
            } catch (e) {
                alert('getUserMedia threw exception :' + e);
            }

        }

        function onMicrophoneDenied() {
            alert('Ton micro marche pas, gros.');
        }

        var mediaStreamSource = null;

        function onMicrophoneGranted(stream) {
            // Create an AudioNode from the stream.
            mediaStreamSource = audioContext.createMediaStreamSource(stream);

            // Create a new volume meter and connect it.
            meter = createAudioMeter(audioContext);
            mediaStreamSource.connect(meter);

            // kick off the visual updating
            onLevelChange();
        }

        function onLevelChange(time) {
            // clear the background
            canvasContext.clearRect(0, 0, WIDTH, HEIGHT);

            // check if we're currently clipping
            if (Math.round(meter.volume * 1000) > 250) {
                document.getElementById("decibelz").style.color = 'red';
                document.getElementById("CetteSouffrance").src = "assets/intensite/voisine3.png"
            } else if(Math.round(meter.volume * 1000) > 100) {
                document.getElementById("decibelz").style.color = 'orange';
                document.getElementById("CetteSouffrance").src = "assets/intensite/voisine2.png"
            } else {
                document.getElementById("decibelz").style.color = 'black';
                document.getElementById("CetteSouffrance").src = "assets/intensite/voisine1.png"
            }

            //console.log(meter.volume);
            document.getElementById("decibelz").innerHTML = String(Math.round(meter.volume * 1000)) + " db"
            // draw a bar based on the current volume
            canvasContext.fillRect(0, 0, meter.volume * WIDTH * 1.4, HEIGHT);

            // set up the next visual callback
            rafID = window.requestAnimationFrame(onLevelChange);
        }
    </script>



    <script>
        //window.history.pushState("null", "null", "/")
    </script>

    <!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>

</html>